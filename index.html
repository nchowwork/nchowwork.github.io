<script src="https://cdn.auth0.com/js/auth0-spa-js/2.12/auth0-spa-js.production.js"></script>

<script>
  let auth0Client;  // renamed to avoid conflict with global 'auth0'

  async function initAuth0() {
    try {
      auth0Client = await auth0.createAuth0Client({
        domain: "dev-5bqlrrqjf1dyxmue.auth0.com",
        clientId: "nxBsRKbkPyKiKDEhlkHCXC0SfKIKkrEv",
        authorizationParams: {
          redirect_uri: window.location.origin  // auto-uses your current site URL
        }
      });

      // Handle redirect callback (after Auth0 sends user back)
      if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
        await auth0Client.handleRedirectCallback();
        window.history.replaceState({}, document.title, window.location.pathname); // clean URL bar
      }

      updateUI();
    } catch (error) {
      console.error("Auth0 initialization failed:", error);
      alert("Failed to initialize Auth0. Check console for details (likely config or network issue).");
    }
  }

  async function updateUI() {
    if (!auth0Client) return;

    const isAuthenticated = await auth0Client.isAuthenticated();

    if (isAuthenticated) {
      const user = await auth0Client.getUser();
      document.getElementById("login-form").style.display = "none";
      const msg = document.getElementById("success-message");
      msg.style.display = "block";
      msg.innerHTML = `
        Welcome, ${user.name || user.email || user.nickname || "User"}!<br>
        Logged in via Auth0.<br>
        <button onclick="logout()">Logout</button>
      `;
    } else {
      // Attach click handler only once
      const btn = document.getElementById("auth-login-btn");
      btn.addEventListener("click", login);
    }
  }

  async function login() {
    if (!auth0Client) return;
    await auth0Client.loginWithRedirect();
  }

  async function logout() {
    if (!auth0Client) return;
    await auth0Client.logout({
      logoutParams: { returnTo: window.location.origin }
    });
  }

  // Start on page load
  window.addEventListener("load", initAuth0);
</script>
